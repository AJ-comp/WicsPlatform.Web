@using WicsPlatform.Server.Models.wics

<RadzenCard class="mt-4 collapsible-panel-container">
    <!-- 클릭 가능한 커스텀 헤더 -->
    <div @onclick="TogglePanel"
         style="background-color: var(--rz-sidebar-background-color); padding: 1rem 1.5rem; cursor: pointer; transition: all 0.3s ease; user-select: none; border-radius: var(--rz-border-radius) var(--rz-border-radius) 0 0; border-bottom: 1px solid var(--rz-border-color);">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="mic" Style="font-size: 1.5rem; color: var(--rz-success);" />
                <RadzenText TextStyle="TextStyle.H5" class="mb-0">
                    @(Channel?.Name ?? "채널") - 마이크데이터
                </RadzenText>
                <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="방송 중" Class="ms-2" />
            </RadzenStack>
            <RadzenIcon Icon="@(IsCollapsed ? "expand_more" : "expand_less")"
                        Style="font-size: 1.5rem; transition: transform 0.3s ease;"
                        class="@(IsCollapsed ? "rotate-icon" : "")" />
        </RadzenStack>
    </div>

    <!-- 패널 내용 -->
    @if (!IsCollapsed)
    {
        <div class="panel-content">
            <RadzenStack Gap="1rem">
                <!-- 마이크 상태 정보 -->
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard>
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-1">
                                    <RadzenIcon Icon="volume_up" class="me-2" />
                                    오디오 레벨
                                </RadzenText>
                                <RadzenProgressBar Value="@AudioLevel" Max="100"
                                                   Style="height: 20px;"
                                                   ProgressBarStyle="ProgressBarStyle.Success" />
                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                                    현재 레벨: @AudioLevel.ToString("F1")%
                                </RadzenText>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard>
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-1">
                                    <RadzenIcon Icon="timer" class="me-2" />
                                    방송 시간
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" class="mb-0">
                                    @BroadcastDuration
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                                    시작: @BroadcastStartTime.ToString("HH:mm:ss")
                                </RadzenText>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <!-- 오디오 데이터 통계 -->
                <RadzenCard>
                    <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-3">
                        <RadzenIcon Icon="analytics" class="me-2" />
                        오디오 데이터 통계
                    </RadzenText>
                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="6" SizeMD="3">
                            <div class="text-center">
                                <RadzenText TextStyle="TextStyle.H6" class="mb-1">@TotalDataPackets</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">전송 패킷</RadzenText>
                            </div>
                        </RadzenColumn>
                        <RadzenColumn Size="6" SizeMD="3">
                            <div class="text-center">
                                <RadzenText TextStyle="TextStyle.H6" class="mb-1">@TotalDataSize KB</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">총 데이터량</RadzenText>
                            </div>
                        </RadzenColumn>
                        <RadzenColumn Size="6" SizeMD="3">
                            <div class="text-center">
                                <RadzenText TextStyle="TextStyle.H6" class="mb-1">@AverageBitrate kbps</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">평균 비트레이트</RadzenText>
                            </div>
                        </RadzenColumn>
                        <RadzenColumn Size="6" SizeMD="3">
                            <div class="text-center">
                                <RadzenText TextStyle="TextStyle.H6" class="mb-1">@SampleRate Hz</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">샘플레이트</RadzenText>
                            </div>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenCard>

                <!-- 방송 제어 버튼들 -->
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="6">
                        <RadzenButton Text="방송 일시정지"
                                      Icon="pause_circle"
                                      ButtonStyle="ButtonStyle.Warning"
                                      Size="ButtonSize.Medium"
                                      Style="width: 100%"
                                      Click="@PauseBroadcast" />
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenButton Text="방송 종료"
                                      Icon="stop_circle"
                                      ButtonStyle="ButtonStyle.Danger"
                                      Size="ButtonSize.Medium"
                                      Style="width: 100%"
                                      Click="@StopBroadcast" />
                    </RadzenColumn>
                </RadzenRow>

                <!-- 실시간 로그 -->
                <RadzenCard>
                    <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-3">
                        <RadzenIcon Icon="receipt_long" class="me-2" />
                        실시간 로그
                    </RadzenText>
                    <div class="broadcast-log"
                         style="height: 200px; overflow-y: auto;
                                    border-radius: var(--rz-border-radius);
                                    padding: 1rem; font-family: monospace; font-size: 0.875rem;
                                    background-color: var(--rz-base-background-color);
                                    border: 1px solid var(--rz-border-color);
                                    color: var(--rz-text-color);">
                        @foreach (var log in broadcastLogs.TakeLast(50).Reverse())
                        {
                            <div class="log-entry" style="margin-bottom: 0.25rem; color: @GetLogColor(log.Level);">
                                <span style="color: var(--rz-text-secondary-color);">[@log.Timestamp.ToString("HH:mm:ss")]</span>
                                <span style="font-weight: bold;">[@log.Level]</span>
                                @log.Message
                            </div>
                        }
                    </div>
                </RadzenCard>

                <!-- 마이크 데이터 디버깅 패널 -->
                <RadzenCard class="mt-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" class="mb-3">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="bug_report" Style="color: var(--rz-warning);" />
                            <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-0">
                                마이크 데이터 디버깅
                            </RadzenText>
                        </RadzenStack>
                        <RadzenSwitch @bind-Value="@showDebugPanel" Change="@(() => StateHasChanged())" />
                    </RadzenStack>

                    @if (showDebugPanel)
                    {
                        <RadzenTabs>
                            <Tabs>
                                <RadzenTabsItem Text="오디오 스트림">
                                    <RadzenCard class="debug-content">
                                        <RadzenRow Gap="1rem">
                                            <RadzenColumn Size="6">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">스트림 상태</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body1">@streamStatus</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="6">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">샘플링 레이트</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body1">@sampleRate Hz</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="6">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">오디오 채널</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body1">@audioChannels</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="6">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">버퍼 크기</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body1">@bufferSize bytes</RadzenText>
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenCard>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="웨이브폼">
                                    <RadzenCard class="debug-content">
                                        <canvas id="waveformCanvas" width="600" height="150"
                                                style="width: 100%; height: 150px; background: #000; border-radius: 4px;">
                                        </canvas>
                                        <RadzenRow class="mt-2">
                                            <RadzenColumn Size="4">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">피크 레벨</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2">@peakLevel.ToString("F3")</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="4">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">RMS 레벨</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2">@rmsLevel.ToString("F3")</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="4">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">클리핑</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2" Style="@(isClipping ? "color: var(--rz-danger);" : "")">
                                                    @(isClipping ? "감지됨" : "정상")
                                                </RadzenText>
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenCard>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="바이너리 데이터">
                                    <RadzenCard class="debug-content">
                                        <div style="height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.75rem; background: #1e1e1e; color: #00ff00; padding: 0.5rem; border-radius: 4px;">
                                            @if (recentAudioData.Any())
                                            {
                                                @foreach (var data in recentAudioData.TakeLast(10))
                                                {
                                                    <div style="margin-bottom: 0.5rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem;">
                                                        <div style="color: #888;">[@data.Timestamp.ToString("HH:mm:ss.fff")] 크기: @data.Size bytes</div>
                                                        <div style="word-break: break-all;">@data.HexPreview</div>
                                                        <div style="color: #0ff; font-size: 0.7rem;">@data.BinaryPreview</div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div style="color: #888;">오디오 데이터 대기 중...</div>
                                            }
                                        </div>
                                    </RadzenCard>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="성능 지표">
                                    <RadzenCard class="debug-content">
                                        <RadzenChart>
                                            <RadzenLineSeries Data="@performanceData" CategoryProperty="Time" ValueProperty="Latency" Title="레이턴시 (ms)">
                                                <RadzenMarkers MarkerType="MarkerType.Circle" />
                                            </RadzenLineSeries>
                                            <RadzenCategoryAxis>
                                                <RadzenAxisTitle Text="시간" />
                                            </RadzenCategoryAxis>
                                            <RadzenValueAxis>
                                                <RadzenAxisTitle Text="레이턴시 (ms)" />
                                            </RadzenValueAxis>
                                        </RadzenChart>
                                        <RadzenRow class="mt-3">
                                            <RadzenColumn Size="3">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">평균 레이턴시</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2">@averageLatency.ToString("F1") ms</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="3">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">드롭된 프레임</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2">@droppedFrames</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="3">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">버퍼 언더런</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2">@bufferUnderruns</RadzenText>
                                            </RadzenColumn>
                                            <RadzenColumn Size="3">
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">처리 시간</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Body2">@processingTime.ToString("F2") ms</RadzenText>
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenCard>
                                </RadzenTabsItem>
                            </Tabs>
                        </RadzenTabs>
                    }
                </RadzenCard>
            </RadzenStack>
        </div>
    }
</RadzenCard>

<style>
    .collapsible-panel-container {
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .panel-content {
        padding: 1.5rem;
        animation: slideDown 0.3s ease-out;
        background-color: var(--rz-base-background-color);
        border-radius: 0 0 var(--rz-border-radius) var(--rz-border-radius);
        border: 1px solid var(--rz-border-color);
        border-top: none;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .rotate-icon {
        transform: rotate(-90deg);
    }

    .broadcast-log {
        scrollbar-width: thin;
        scrollbar-color: var(--rz-border-color) transparent;
        /* CSS 변수를 사용하여 자동으로 테마에 맞게 조정 */
        background-color: var(--rz-base-background-color) !important;
        color: var(--rz-text-color) !important;
        border-color: var(--rz-border-color) !important;
    }

        .broadcast-log::-webkit-scrollbar {
            width: 6px;
        }

        .broadcast-log::-webkit-scrollbar-track {
            background: var(--rz-base-background-color);
        }

        .broadcast-log::-webkit-scrollbar-thumb {
            background: var(--rz-border-color);
            border-radius: 3px;
        }

            .broadcast-log::-webkit-scrollbar-thumb:hover {
                background: var(--rz-text-secondary-color);
            }

    .log-entry {
        line-height: 1.4;
    }

    /* 디버깅 패널 스타일 */
    .debug-content {
        min-height: 250px;
        background-color: var(--rz-base-100);
    }

        .debug-content .rz-chart {
            height: 200px;
        }

    /* 다크 테마 디버깅 패널 */
    :root[data-theme='dark'] .debug-content {
        background-color: var(--rz-base-200);
    }
</style>
