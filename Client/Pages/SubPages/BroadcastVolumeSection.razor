@using WicsPlatform.Server.Models.wics
@implements IDisposable

<RadzenCard class="mt-3 collapsible-panel-container">
    <!-- 클릭 가능한 커스텀 헤더 -->
    <div @onclick="TogglePanel"
         style="background-color: var(--rz-sidebar-background-color); padding: 0.75rem 1rem; cursor: pointer; transition: all 0.3s ease; user-select: none; border-radius: var(--rz-border-radius) var(--rz-border-radius) 0 0; border-bottom: 1px solid var(--rz-border-color);">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.375rem">
                <RadzenIcon Icon="volume_up" Style="font-size: 1.25rem; color: var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-0" Style="font-size: 0.95rem;">
                    @(Channel?.Name ?? "채널") - 볼륨 설정
                </RadzenText>
                @if (_hasUnsavedChanges)
                {
                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true" Text="저장 필요"
                                 Style="font-size: 0.6rem; padding: 2px 6px;" />
                }
            </RadzenStack>
            <RadzenIcon Icon="@(IsCollapsed ? "expand_more" : "expand_less")"
                        Style="font-size: 1.25rem; transition: transform 0.3s ease;"
                        class="@(IsCollapsed ? "rotate-icon" : "")" />
        </RadzenStack>
    </div>

    <!-- 패널 내용 -->
    @if (!IsCollapsed)
    {
        <div class="panel-content" Style="padding: 1rem;">
            <RadzenStack Gap="1rem">
                <!-- 볼륨 컨트롤 영역 -->
                <RadzenRow Gap="1rem">
                    <!-- 마이크 볼륨 -->
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                        <RadzenCard class="volume-control-card" Style="padding: 0.75rem;">
                            <RadzenStack Gap="0.625rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.375rem">
                                        <RadzenIcon Icon="mic" Style="font-size: 1rem; color: var(--rz-info);" />
                                        <RadzenText TextStyle="TextStyle.Body2" class="mb-0" Style="font-weight: 600; font-size: 0.875rem;">마이크 볼륨</RadzenText>
                                    </RadzenStack>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" IsPill="true" Text="@($"{micVolume}%")"
                                                 Style="font-size: 0.7rem; padding: 2px 8px;" />
                                </RadzenStack>

                                <RadzenSlider @bind-Value="@micVolume"
                                              TValue="int"
                                              Min="0"
                                              Max="100"
                                              Step="1"
                                              Change="@((int value) => UpdateVolume("mic", value))"
                                              Style="width: 100%; height: 6px;" />

                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">0%</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">100%</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <!-- TTS 볼륨 -->
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                        <RadzenCard class="volume-control-card" Style="padding: 0.75rem;">
                            <RadzenStack Gap="0.625rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.375rem">
                                        <RadzenIcon Icon="record_voice_over" Style="font-size: 1rem; color: var(--rz-success);" />
                                        <RadzenText TextStyle="TextStyle.Body2" class="mb-0" Style="font-weight: 600; font-size: 0.875rem;">TTS 볼륨</RadzenText>
                                    </RadzenStack>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="@($"{ttsVolume}%")"
                                                 Style="font-size: 0.7rem; padding: 2px 8px;" />
                                </RadzenStack>

                                <RadzenSlider @bind-Value="@ttsVolume"
                                              TValue="int"
                                              Min="0"
                                              Max="100"
                                              Step="1"
                                              Change="@((int value) => UpdateVolume("tts", value))"
                                              Style="width: 100%; height: 6px;" />

                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">0%</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">100%</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <!-- 미디어 볼륨 -->
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                        <RadzenCard class="volume-control-card" Style="padding: 0.75rem;">
                            <RadzenStack Gap="0.625rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.375rem">
                                        <RadzenIcon Icon="library_music" Style="font-size: 1rem; color: var(--rz-warning);" />
                                        <RadzenText TextStyle="TextStyle.Body2" class="mb-0" Style="font-weight: 600; font-size: 0.875rem;">미디어 볼륨</RadzenText>
                                    </RadzenStack>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true" Text="@($"{mediaVolume}%")"
                                                 Style="font-size: 0.7rem; padding: 2px 8px;" />
                                </RadzenStack>

                                <RadzenSlider @bind-Value="@mediaVolume"
                                              TValue="int"
                                              Min="0"
                                              Max="100"
                                              Step="1"
                                              Change="@((int value) => UpdateVolume("media", value))"
                                              Style="width: 100%; height: 6px;" />

                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">0%</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">100%</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <!-- 전체 볼륨 -->
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                        <RadzenCard class="volume-control-card" Style="padding: 0.75rem;">
                            <RadzenStack Gap="0.625rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.375rem">
                                        <RadzenIcon Icon="volume_up" Style="font-size: 1rem; color: var(--rz-primary);" />
                                        <RadzenText TextStyle="TextStyle.Body2" class="mb-0" Style="font-weight: 600; font-size: 0.875rem;">전체 볼륨</RadzenText>
                                    </RadzenStack>
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" IsPill="true" Text="@($"{globalVolume}%")"
                                                 Style="font-size: 0.7rem; padding: 2px 8px;" />
                                </RadzenStack>

                                <RadzenSlider @bind-Value="@globalVolume"
                                              TValue="int"
                                              Min="0"
                                              Max="100"
                                              Step="1"
                                              Change="@((int value) => UpdateVolume("global", value))"
                                              Style="width: 100%; height: 6px;" />

                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">0%</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted mb-0" Style="font-size: 0.65rem;">100%</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <!-- 저장 버튼 영역 -->
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.75rem" class="mt-2">
                    <RadzenButton Text="기본값으로 재설정"
                                  Icon="refresh"
                                  ButtonStyle="ButtonStyle.Light"
                                  Size="ButtonSize.Small"
                                  Style="height: 32px; font-size: 0.875rem;"
                                  Click="@ResetVolumes" />
                    <RadzenButton Text="볼륨 설정 저장"
                                  Icon="save"
                                  ButtonStyle="@(_hasUnsavedChanges ? ButtonStyle.Warning : ButtonStyle.Primary)"
                                  Size="ButtonSize.Small"
                                  Style="height: 32px; font-size: 0.875rem;"
                                  Click="@SaveVolumes"
                                  IsBusy="@isSavingVolumes" />
                </RadzenStack>

                @if (_hasUnsavedChanges)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" ShowIcon="true" Icon="warning" 
                                 Style="margin-top: 0.5rem; padding: 0.5rem;">
                        <RadzenText TextStyle="TextStyle.Caption" Style="font-size: 0.75rem;">
                            볼륨 설정이 변경되었습니다. '볼륨 설정 저장' 버튼을 클릭하여 변경사항을 저장하세요.
                        </RadzenText>
                    </RadzenAlert>
                }
            </RadzenStack>
        </div>
    }
</RadzenCard>

<style>
    .volume-control-card {
        transition: all 0.3s ease;
        height: 100%;
    }

        .volume-control-card:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        /* 슬라이더 스타일 커스터마이징 */
        .volume-control-card .rz-slider {
            margin: 0.5rem 0;
        }

        .volume-control-card .rz-slider-horizontal .rz-slider-track {
            height: 6px !important;
            background-color: var(--rz-base-300);
        }

        .volume-control-card .rz-slider-horizontal .rz-slider-range {
            height: 6px !important;
        }

        .volume-control-card .rz-slider-handle {
            width: 16px !important;
            height: 16px !important;
            top: -5px !important;
        }

    .collapsible-panel-container {
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .panel-content {
        animation: slideDown 0.3s ease-out;
        background-color: var(--rz-base-background-color);
        border-radius: 0 0 var(--rz-border-radius) var(--rz-border-radius);
        border: 1px solid var(--rz-border-color);
        border-top: none;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .rotate-icon {
        transform: rotate(-90deg);
    }

    /* 다크 테마 지원 */
    :root[data-theme='dark'] .volume-control-card {
        background-color: var(--rz-base-100);
    }

        :root[data-theme='dark'] .volume-control-card:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

    :root[data-theme='dark'] .text-muted {
        color: var(--rz-text-secondary-color) !important;
    }
</style>