@using WicsPlatform.Server.Models.wics

<RadzenCard class="mt-3 collapsible-panel-container">
<!-- 패널 헤더 -->
<div @onclick="TogglePanel"
     style="background-color: var(--rz-sidebar-background-color); padding: 0.75rem 1rem; cursor: pointer; transition: all 0.3s ease; user-select: none; border-radius: var(--rz-border-radius) var(--rz-border-radius) 0 0; border-bottom: 1px solid var(--rz-border-color);">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.375rem">
            <RadzenIcon Icon="monitoring" Style="font-size: 1.25rem; color: var(--rz-success);" />
            <RadzenText TextStyle="TextStyle.Subtitle1" class="mb-0" Style="font-size: 0.95rem;">
                @(Channel?.Name ?? "채널") - 방송 모니터링
            </RadzenText>
            <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="방송 중" Style="font-size: 0.65rem; padding: 2px 8px;" />
        </RadzenStack>
        <RadzenIcon Icon="@(IsCollapsed ? "expand_more" : "expand_less")"
                    Style="font-size: 1.25rem; transition: transform 0.3s ease;"
                    class="@(IsCollapsed ? "rotate-icon" : "")" />
    </RadzenStack>
</div>

<!-- 패널 내용 -->
@if (!IsCollapsed)
{
    <div class="panel-content" Style="padding: 1rem;">
            <RadzenStack Gap="0.75rem">
                <!-- 방송 상태 정보 -->
                <RadzenRow Gap="0.5rem">
                    <!-- 활성 소스 표시 -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenCard class="info-card" Style="padding: 0.75rem; height: 100%;">
                            <RadzenStack Gap="0.25rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="source" class="info-icon" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="info-title">활성 방송 소스</RadzenText>
                                </RadzenStack>
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                    @if (IsMicEnabled)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" IsPill="true" Text="마이크" class="source-badge" />
                                    }
                                    @if (IsMediaEnabled)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true" Text="미디어" class="source-badge" />
                                    }
                                    @if (IsTtsEnabled)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" Text="TTS" class="source-badge" />
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <!-- 오디오 레벨 -->
                    @if (IsMicEnabled)
                    {
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard class="info-card" Style="padding: 0.75rem; height: 100%;">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="volume_up" class="info-icon" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="info-title">오디오 레벨</RadzenText>
                                    </RadzenStack>
                                    <RadzenProgressBar Value="@AudioLevel" Max="100" class="audio-progress" ProgressBarStyle="ProgressBarStyle.Success" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="info-value">
                                        @AudioLevel.ToString("F1")%
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>
                    }

                    <!-- 방송 시간 -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenCard class="info-card" Style="padding: 0.75rem; height: 100%;">
                            <RadzenStack Gap="0.25rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="timer" class="info-icon" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="info-title">방송 시간</RadzenText>
                                </RadzenStack>
                                <RadzenText TextStyle="TextStyle.Body1" class="info-main-value">
                                    @BroadcastDuration
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="info-sub-value">
                                    시작: @BroadcastStartTime.ToString("HH:mm:ss")
                                </RadzenText>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <!-- 데이터 통계 -->
                <RadzenCard Style="padding: 0.75rem;">
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="analytics" Style="font-size: 0.875rem; color: var(--rz-primary);" />
                            <RadzenText TextStyle="TextStyle.Subtitle2"><strong>방송 데이터 통계</strong></RadzenText>
                        </RadzenStack>
                        <RadzenRow Gap="0.5rem">
                            <RadzenColumn Size="6" SizeMD="3">
                                <div class="stat-item">
                                    <RadzenText TextStyle="TextStyle.Body2" class="stat-value">@TotalDataPackets</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="stat-label">전송 패킷</RadzenText>
                                </div>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <div class="stat-item">
                                    <RadzenText TextStyle="TextStyle.Body2" class="stat-value">@TotalDataSize.ToString("F2") KB</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="stat-label">총 데이터량</RadzenText>
                                </div>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <div class="stat-item">
                                    <RadzenText TextStyle="TextStyle.Body2" class="stat-value">@AverageBitrate.ToString("F2") kbps</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="stat-label">평균 비트레이트</RadzenText>
                                </div>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <div class="stat-item">
                                    <RadzenText TextStyle="TextStyle.Body2" class="stat-value">@SampleRate Hz</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="stat-label">샘플레이트</RadzenText>
                                </div>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenCard>

                <!-- 방송 제어 버튼들 -->
                <RadzenRow Gap="0.5rem">
                    <RadzenColumn Size="6">
                        <RadzenButton Text="일시정지"
                                      Icon="pause_circle"
                                      ButtonStyle="ButtonStyle.Warning"
                                      Size="ButtonSize.Small"
                                      class="control-button"
                                      Click="@PauseBroadcast" />
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenButton Text="방송 종료"
                                      Icon="stop_circle"
                                      ButtonStyle="ButtonStyle.Danger"
                                      Size="ButtonSize.Small"
                                      class="control-button"
                                      Click="@StopBroadcast" />
                    </RadzenColumn>
                </RadzenRow>

                <!-- 실시간 로그 -->
                <RadzenCard Style="padding: 0.75rem;">
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="receipt_long" Style="font-size: 0.875rem; color: var(--rz-primary);" />
                            <RadzenText TextStyle="TextStyle.Subtitle2"><strong>실시간 로그</strong></RadzenText>
                        </RadzenStack>
                        <div class="log-container">
                            @foreach (var log in broadcastLogs.TakeLast(50).Reverse())
                            {
                                <div class="log-entry @GetLogClass(log.Level)">
                                    <span class="log-time">[@log.Timestamp.ToString("HH:mm:ss")]</span>
                                    <span class="log-level">[@log.Level]</span>
                                    <span class="log-message">@log.Message</span>
                                </div>
                            }
                        </div>
                    </RadzenStack>
                </RadzenCard>

                <!-- 마이크 디버깅 패널 (옵션) -->
                @if (IsMicEnabled && showDebugPanel)
                {
                    <RadzenCard Style="padding: 0.75rem; background-color: rgba(var(--rz-warning-rgb), 0.1); border: 1px solid var(--rz-warning);">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenIcon Icon="bug_report" Style="font-size: 0.875rem; color: var(--rz-warning);" />
                                <RadzenText TextStyle="TextStyle.Subtitle2"><strong>마이크 데이터 디버깅</strong></RadzenText>
                            </RadzenStack>
                            <RadzenSwitch @bind-Value="@showDebugPanel" />
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        </div>
    }
</RadzenCard>

<style>
    .collapsible-panel-container {
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .panel-content {
        animation: slideDown 0.3s ease-out;
        background-color: var(--rz-base-background-color);
        border-radius: 0 0 var(--rz-border-radius) var(--rz-border-radius);
        border: 1px solid var(--rz-border-color);
        border-top: none;
    }

    .rotate-icon {
        transform: rotate(-90deg);
    }

    /* 정보 카드 */
    .info-card {
        background: rgba(var(--rz-primary-rgb), 0.05) !important;
        border: 1px solid var(--rz-border-color) !important;
    }

    .info-icon {
        font-size: 0.875rem !important;
        color: var(--rz-primary) !important;
    }

    .info-title {
        font-size: 0.7rem !important;
        font-weight: 500 !important;
        color: var(--rz-text-secondary-color) !important;
        margin: 0 !important;
    }

    .info-main-value {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        margin: 0 !important;
    }

    .info-value {
        font-size: 0.75rem !important;
        margin: 0 !important;
    }

    .info-sub-value {
        font-size: 0.65rem !important;
        color: var(--rz-text-secondary-color) !important;
        margin: 0 !important;
    }

    .source-badge {
        font-size: 0.65rem !important;
        padding: 2px 6px !important;
    }

    .audio-progress {
        height: 14px !important;
    }

    /* 통계 아이템 */
    .stat-item {
        text-align: center;
        padding: 0.625rem;
        background: rgba(var(--rz-primary-rgb), 0.05);
        border-radius: var(--rz-border-radius);
        border: 1px solid var(--rz-border-color);
        transition: all 0.2s ease;
    }

        .stat-item:hover {
            background: rgba(var(--rz-primary-rgb), 0.1);
            transform: translateY(-2px);
            box-shadow: var(--rz-shadow-2);
        }

    .stat-value {
        font-size: 0.95rem !important;
        font-weight: 600 !important;
        margin: 0 !important;
    }

    .stat-label {
        font-size: 0.65rem !important;
        color: var(--rz-text-secondary-color) !important;
        margin: 0 !important;
    }

    /* 제어 버튼 */
    .control-button {
        width: 100% !important;
        height: 32px !important;
        font-size: 0.75rem !important;
    }

    /* 로그 컨테이너 */
    .log-container {
        height: 180px;
        overflow-y: auto;
        background: var(--rz-base-900, #0d1117);
        border-radius: var(--rz-border-radius);
        padding: 0.625rem;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.7rem;
        line-height: 1.5;
        border: 1px solid var(--rz-border-color);
    }

    .log-entry {
        margin-bottom: 0.25rem;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .log-time {
        color: var(--rz-text-disabled-color, #8b949e);
        font-weight: 500;
    }

    .log-level {
        font-weight: 700;
        margin: 0 0.375rem;
    }

    .log-message {
        color: var(--rz-text-color, #c9d1d9);
    }

    .log-entry.ERROR .log-level {
        color: var(--rz-danger, #f85149);
    }

    .log-entry.WARN .log-level {
        color: var(--rz-warning, #f39c12);
    }

    .log-entry.INFO .log-level {
        color: var(--rz-info, #58a6ff);
    }

    .log-entry.SUCCESS .log-level {
        color: var(--rz-success, #56d364);
    }

    .log-entry.DEBUG .log-level {
        color: var(--rz-text-disabled-color, #8b949e);
    }

    /* 스크롤바 */
    .log-container::-webkit-scrollbar {
        width: 6px;
    }

    .log-container::-webkit-scrollbar-track {
        background: var(--rz-base-200);
        border-radius: 3px;
    }

    .log-container::-webkit-scrollbar-thumb {
        background: var(--rz-base-400);
        border-radius: 3px;
    }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: var(--rz-base-500);
        }

    /* 애니메이션 */
    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>